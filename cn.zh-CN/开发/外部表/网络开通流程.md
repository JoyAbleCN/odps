---
keyword: [网络开通, SmartNAT, Private Access]
---

# 网络开通流程

MaxCompute支持通过外部表、UDF及湖仓一体等功能访问公网或VPC网络中的其它阿里云服务，并对外部表数据进行处理。在访问前您需要先开通MaxCompute和目标HBase、RDS及Hadoop集群等连通目标的网络连接。本文主要为您介绍网络开通流程。

## 网络结构

MaxCompute、HBase、RDS及Hadoop集群等目标数据源的网络结构如下。

![网络架构](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/9019673061/p175927.png)

|类别|描述|
|--|--|
|MaxCompute域|MaxCompute是用户使用的Saas模式云数据仓库，本身也处在一个网络环境中，您可以可通过外部表、UDF或湖仓一体等功能访问外部网络。|
|网络连接域|MaxCompute访问目标网络有SmartNAT和Private Access（VPC专线方案）两种方案。详情请参见[SmartNAT方案](#section_qw7_3ga_lg8)和[Private Access方案](#section_qug_auu_qn2)。|
|目标域|-   公网IP或域名是用户需要访问的Internet上的网络IP或域名地址。
-   VPC是用户在阿里云上开通的虚拟专用网络，内部为ECS服务器、RDS的IP或服务实例名、或Hbase、Hadoop等服务或托管集群的网段。
-   弹性网卡ENI（Elastic Network Interface）是一种可以绑定到专有网络VPC类型ECS实例上的虚拟网卡。通过弹性网卡，可以实现精细化的网络管理。
-   OSS、OTS等阿里云服务也是MaxCompute可以访问的目标。这些服务的网络已经与MaxCompute打通，可以直接连通使用。 |

## 前提条件

-   您需要提前获取待开通的公网、RDS、HBase集群或Hadoop集群（云上自建或EMR）的相关信息。例如HiveMetaStore的IP和端口，HDFS NameNode的IP和端口。
-   已创建MaxCompute项目空间。直接使用开通时创建的项目空间即可，不必再创建新项目空间。注意，开通的MaxCompute所在区域必须和RDS、Hbase集群、Hadoop集群所使用的VPC处于相同区域。如果项目空间用于实现湖仓一体功能，建议设置项目空间的数据类型为Hive兼容类型。
-   如果需要打通VPC网络，请提前获取VPC所有者账号。同时还需要获取MaxComoute项目空间的主账号，以及目标网络或集群的管理员账号。

## 开通区域

SmartNAT方案和Private Access方案已在部分区域开通，详情如下。其他区域暂不支持。

|方案类型|支持区域|支持打通的目标系统或集群|
|----|----|------------|
|SmartNAT|-   华北2（北京）
-   华东2（上海）

|-   公网IP或域名
-   VPC IP或域名
-   RDS |
|Private Access|-   华北2（北京）
-   华东2（上海）
-   华北3（张家口）
-   华东1（杭州）

|-   公网IP或域名
-   VPC IP或域名
-   RDS
-   HBase
-   Hadoop |

## SmartNAT方案

SmartNAT方案为云上预置网络资源，MaxCompute可以根据配置的目标IP在作业运行时自动打通网络，连接映射目标。

SmartNAT可以访问公网或VPC中的单个IP目标或域名。

-   **访问公网**

    MaxCompute访问公网需要按照如下步骤进行操作：

    1.  [提工单](https://selfservice.console.aliyun.com/ticket/createIndex)申请配置目标公网的IP或域名、端口的白名单。管理员需要修改项目空间配置`setproject odps.security.outbound.internetlist=ip_address,realm_name:port;`，填写目标IP或域名、端口，如果有多个域名或端口需要访问，使用英文逗号（,）分隔。
    2.  确认工单处理完毕后，即可在[MaxCompute客户端](/cn.zh-CN/工具及下载/客户端.md)运行作业。命令示例如下：

        ```
        set odps.internet.access.list=*ip\_address:port丨realm\_name:port*; --设置要访问的公网目标IP或域名、端口。
        SELECT *UDF\_name*("*http://ip\_address丨realm\_name*");
        ```

        -   ip\_address:port丨realm\_name:port：目标公网IP或域名、端口。
        -   UDF\_name：访问公网的UDF。UDF创建示例如下：

            ```
            package com.aliyun.odps.test.udf;
            import com.aliyun.odps.udf.UDF;
            import java.io.BufferedReader;
            import java.io.IOException;
            import java.io.InputStreamReader;
            import java.net.URL;
            public class *UDF\_name* extends UDF {
              public String evaluate(String urlStr) throws IOException {
                URL url = new URL(urlStr);
                StringBuilder sb = new StringBuilder();
                try (BufferedReader reader = new BufferedReader(new InputStreamReader(url.openStream()))) {
                  String line;
                  while ((line = reader.readLine()) != null) {
                    sb.append(line).append('\n');
                  }
                }
                return sb.toString();
              }
            }
            ```

        命令示例如下：

        ```
        set odps.internet.access.list=www.aliyun.com:80;
        SELECT url_fetch("http://www.aliyun.com");
        ```

-   **访问VPC网络**

    MaxCompute访问VPC网络需要按照如下步骤进行操作：

    1.  在目标VPC网络中设置允许MaxCompute访问。您需要在VPC的安全组中添加MaxCompute的白名单网段。

        |区域|安全组IP网段|
        |--|-------|
        |华东2（上海）|100.104.49.64/26、100.104.212.192/26、100.104.244.0/26、100.104.94.0/26|
        |华北2（北京）|100.104.218.0/26、100.104.120.0/26、100.104.156.192/26、100.104.149.0/26、100.104.49.64/26、100.104.212.192/26、100.104.244.0/26、100.104.94.0/26|

    2.  登录[MaxCompute客户端](/cn.zh-CN/工具及下载/客户端.md)，设置目标VPC网络。命令语法如下：

        ```
        setproject odps.security.outbound.destination=*RegionID*_*VPC ID**\[\*\]*;  --将目标VPC网络添加至MaxCompute的白名单。
        ```

        -   RegionID：VPC网络所在的区域ID。详情请参见[RegionID](/cn.zh-CN/开发/常用命令/项目空间操作.md)。
        -   VPC ID：VPC网络ID号。
        -   \[\*\]：通配符，表示VPC网络下的所有IP和端口都加入MaxCompute白名单。
        命令示例如下：

        ```
        setproject odps.security.outbound.destination=cn-shanghai_vpc-bp1e4p7feyvwt103j****[*];
        ```

    3.  在MaxCompute客户端提交SQL，通过UDF访问VPC网络中的目标IP。命令示例如下：

        ```
        set odps.vpc.id=vpc-bp1e4p7feyvwt103j****; --指定要访问的VPC ID。
        set odps.vpc.access.ips=192.0.2.0:80;      --指定要访问的VPC IP和端口号。
        SELECT url_fetch("http://192.0.2.0:80");   --使用UDF访问目标VPC网络。
        ```


## Private Access方案

Private Access方案（VPC专线方案）需要创建网络专线，并经过授权才能让MaxCompute访问位于VPC内的服务。这些权限包括允许MaxCompute 从用户VPC内创建并绑定ENI弹性网卡，以及对MaxCompute暴露必要的VPC中的服务，例如RDS、Hbase集群和Hadoop集群中的服务（HiveMetaStore和HDFS）。Private Access可以打通目标VPC中的多个IP或网段。

通过Private Access方案开通网络的流程如下：

1.  通过RAM授权，支持MaxCompute在用户VPC服务内创建ENI网卡，实现MaxCompute与用户VPC服务间的连接。您需要使用VPC所有者账号，在登录阿里云状态下单击[授权](https://ram.console.aliyun.com/#/role/authorize?request=%7B%22Requests%22%3A%7B%22request1%22%3A%7B%22RoleName%22%3A%22AliyunODPSRoleForENI%22%2C%22TemplateId%22%3A%22AliyunODPSRoleForENI%22%7D%7D%2C%22ReturnUrl%22%3A%22https%3A%2F%2Fram.console.aliyun.com%2Froles%22%2C%22Service%22%3A%22ODPS%22%7D)，确认后即可完成授权。
2.  为ENI创建独立安全组，并记录安全组的ID。

    安全组用于控制MaxCompute对VPC网络内的各种资源的访问权限。由MaxCompute创建的ENI网卡将位于这个安全组内统一管理。MaxCompute在后续的创建网络通路过程中会根据带宽需求创建2个或更多ENI实例。

    **说明：** 安全组为普通安全组，不是企业安全组。普通安全组的出口是默认开启的。企业安全组的出口是默认关闭的，会导致访问不了任何用户VPC内的任何服务。如果用户的HBase无法对某个安全组开放网络权限，MaxCompute技术服务团队开通后，用户的安全组内会出现两个以上的弹性网卡，开放MaxCompute对应的弹性网卡IP即可。但是MaxCompute配置变更时，弹性网卡IP可能会发生变化，所以开放交换机的网段IP比较方便。

3.  配置目标集群防火墙或安全组。
    -   配置Hadoop集群防火墙或安全组

        MaxCompute通过ENI的安全组来访问Hadoop集群，因此也需要Hadoop集群的安全组或防火墙对ENI 所在安全组的入方向开放必要的端口：

        -   操作Hadoop集群所在安全组的入方向访问规则。
        -   授权对象限定在ENI所在的安全组。
        -   HiveMetaStore端口，通常是9083。
        -   HDFS NameNode端口，通常是8020。
        -   HDFS DataNode端口，通常是50010。
        ![配置防火墙或安全组](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/9019673061/p176584.png)

    -   配置HBase集群防火墙或安全组

        HBase设置白名单和安全组的操作详情请参见[设置白名单和安全组]()。

    -   配置RDS安全组

        RDS设置白名单等安全策略的操作详情请参见[访问控制](/cn.zh-CN/安全白皮书/访问控制.md)。

4.  [提工单](https://selfservice.console.aliyun.com/ticket/createIndex)，由MaxCompute技术服务团队创建网络通路。您需要提供如下信息并等待MaxCompute技术服务团队完成配置：
    -   可用区ID：您可以在EMR场景下控制台网络信息处获取该信息。
    -   专有网络ID：您可以在EMR场景下控制台网络信息处获取该信息。
    -   交换机ID：您可以在EMR场景下控制台网络信息处获取该信息。
    -   ENI安全组ID（步骤2中创建的安全组）。
    -   主账号ID：您可以在阿里云个人信息中获取。
5.  访问目标网络。详情请参见：
    -   [HBase数据源外部表](/cn.zh-CN/开发/外部表/HBase数据源外部表.md)
    -   [RDS数据源外部表](/cn.zh-CN/开发/外部表/RDS数据源外部表.md)

